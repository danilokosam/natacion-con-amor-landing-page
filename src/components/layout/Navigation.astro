---
import Social from "../ui/Social.astro";
import { getCollection } from "astro:content";

// Fetch static data from the 'staticData' collection.
const [staticData] = await getCollection("staticData");
// Destructure social media links and icon names from the fetched data.
const { instagram, instagramIconName, youtube, youtubeIconName } =
  staticData.data;

// Define the expected props for the component, specifically an array of menu item keys.
const { items = [] }: { items: (keyof typeof menu)[] } = Astro.props as {
  items: (keyof typeof menu)[];
};

// Define the structure of the navigation menu with names and paths for each item.
const menu = {
  about: { name: "Acerca de mi", path: "/acerca-de-mi" },
  // blog: {
  //   name: "Blog",
  //   path: "/blog/",
  //   dropdown: [{ name: "All Posts", path: "/blog/posts/" }],
  // },
  home: { name: "Inicio", path: "/#inicio" },
  classes: { name: "Clases", path: "/#clases" },
  plans: { name: "Planes", path: "/#planes" },
};

// Define common base classes for styling the navigation components.
// This helps maintain a consistent look and feel.
const baseClasses = {
  nav: "nav-links flex w-full justify-center gap-6 max-md:gap-3 max-md:py-6",
  link: "px-2 py-2 transition-all hover:text-mint-300 max-md:mx-auto max-md:w-full max-md:px-6 max-md:py-2 ",
  socialContainer: "flex items-center justify-center gap-5 md:hidden",
  // dropdown: "relative group flex items-center",
  // dropdownMenu:
  //   "absolute left-0 top-full hidden group-hover:block bg-white dark:bg-zinc-800 shadow-lg rounded-md py-2 min-w-[200px] z-50",
  // dropdownItem:
  //   "block px-4 py-2 text-sm hover:bg-mint-100 dark:hover:bg-zinc-700 transition-colors",
} as const;
---

<script>
  // This script runs on the client-side to handle dynamic navigation behavior.
  document.addEventListener("DOMContentLoaded", () => {
    // Check if the current page is the homepage.
    const isHome = window.location.pathname === "/";

    // Define CSS classes for active and inactive link states.
    const linkClasses = {
      active: [
        "text-mint-500", // Color for active link
        "dark:text-mint-400", // Dark mode color for active link
        "font-bold", // Bold font for active link
        "[text-shadow:1px_1px_11px_rgba(208,251,229,0.7)]", // Shadow effect for active link
      ],
      inactive: ["dark:text-zinc-300", "text-blacktext"], // Classes for inactive link
    };

    /**
     * Toggles the CSS classes of a navigation link based on its active state.
     * @param {Element} link - The link element to modify.
     * @param {boolean} isActive - Whether the link should be styled as active.
     */
    function toggleLinkClasses(link: Element, isActive: boolean) {
      if (isActive) {
        link.classList.add(...linkClasses.active);
        link.classList.remove(...linkClasses.inactive);
        link.setAttribute("aria-current", "page");
      } else {
        link.classList.remove(...linkClasses.active);
        link.classList.add(...linkClasses.inactive);
        link.removeAttribute("aria-current");
      }
    }

    /**
     * Updates the active state of navigation links based on the current URL path and hash.
     */
    function updateActiveLink() {
      const currentPath = window.location.pathname;
      const currentHash = window.location.hash
        ? `#${window.location.hash.substring(1)}`
        : "";

      document.querySelectorAll("nav a").forEach((link) => {
        const path = link.getAttribute("data-path");
        toggleLinkClasses(link, path === currentPath || path === currentHash);
      });
    }

    /**
     * Sets up a "scroll spy" that updates the active navigation link as the user scrolls
     * through different sections of the homepage.
     */
    function setupScrollSpy() {
      // Only run scroll spy on the homepage.
      if (!isHome) return;

      const sections = document.querySelectorAll("section[id]");
      const navLinks = document.querySelectorAll("nav a");

      // Configure the IntersectionObserver to detect when a section is in the middle of the viewport.
      const observerOptions = {
        root: null, // Use the viewport as the root.
        rootMargin: "-50% 0px", // Trigger when the section is in the vertical center.
        threshold: 0, // Trigger as soon as any part of the section is visible.
      };

      // Create an observer to watch for section intersections.
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const sectionId = entry.target.getAttribute("id");
            if (sectionId) {
              // Update the active link to correspond to the visible section.
              navLinks.forEach((link) => {
                const path = link.getAttribute("data-path");
                toggleLinkClasses(link, path === `/#${sectionId}`);
              });
            }
          }
        });
      }, observerOptions);

      // Observe each section.
      sections.forEach((section) => observer.observe(section));
    }

    // Initial setup calls.
    updateActiveLink(); // Set the active link on page load.
    setupScrollSpy(); // Set up scroll-based active link updates.
    window.addEventListener("hashchange", updateActiveLink); // Update active link when URL hash changes.
  });
</script>

<!-- Main navigation container -->
<nav class={baseClasses.nav} role="navigation" aria-label="Main Navigation">
  {
    /* Map over the provided 'items' prop to render navigation links. */
    items.map((key) => {
      const item = menu[key as keyof typeof menu];
      if (!item) return null; // Skip if the item key is invalid.

      // If the item has a dropdown, render it as a dropdown menu.
      // if ("dropdown" in item) {
      //   return (
      //     <div class={baseClasses.dropdown}>
      //       {/* Main link for the dropdown */}
      //       <a
      //         href={item.path}
      //         class={baseClasses.link}
      //         data-path={item.path}
      //         aria-label={item.name}
      //         aria-current={
      //           item.path === Astro.url.pathname ? "page" : undefined
      //         }
      //       >
      //         {item.name}
      //       </a>
      //       {/* Dropdown menu container */}
      //       <div class={baseClasses.dropdownMenu}>
      //         {item.dropdown.map((dropdownItem) => (
      //           <a
      //             href={dropdownItem.path}
      //             class={baseClasses.dropdownItem}
      //             data-path={dropdownItem.path}
      //             aria-label={dropdownItem.name}
      //           >
      //             {dropdownItem.name}
      //           </a>
      //         ))}
      //       </div>
      //     </div>
      //   );
      // }

      // Render a standard navigation link.
      return (
        <a
          href={item.path}
          class={baseClasses.link}
          data-path={item.path}
          aria-label={item.name}
          aria-current={item.path === Astro.url.pathname ? "page" : undefined}
        >
          {item.name}
        </a>
      );
    })
  }

  {/* Container for social media links, typically shown on smaller screens. */}
  <div
    class={baseClasses.socialContainer}
    role="group"
    aria-label="Social Media Links"
  >
    <Social link={instagram} iconName={instagramIconName} />
    <Social link={youtube} iconName={youtubeIconName} />
  </div>
</nav>
